name: Deploy API to Production

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DEPLOYMENT_PATH: /home/olloadmin/OlloLifestyle.Webapi
  SERVER_HOST: 118.189.233.238
  SERVER_USER: olloadmin

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release
      
    - name: Test
      run: dotnet test --no-build --verbosity normal --configuration Release

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Build Docker image
      run: |
        docker build -t ollo-api:latest .
        
    - name: Save Docker image
      run: |
        docker save ollo-api:latest | gzip > ollo-api.tar.gz
        
    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ env.SERVER_HOST }}
        username: ${{ env.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # Create deployment directory
          mkdir -p ${{ env.DEPLOYMENT_PATH }}
          mkdir -p /home/olloadmin/logs/api
          mkdir -p /home/olloadmin/logs/nginx
          
          # Stop existing services
          cd ${{ env.DEPLOYMENT_PATH }} || true
          docker-compose -f docker-compose.yml down || true
          
          # Clean up old images
          docker image prune -f || true
          
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.SERVER_HOST }}
        username: ${{ env.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        source: "docker-compose.yml,Dockerfile,OlloLifestyleAPI/,OlloLifestyleAPI.Application/,OlloLifestyleAPI.Core/,OlloLifestyleAPI.Infrastructure/,OlloLifestyleAPI.sln,.dockerignore,.env"
        target: ${{ env.DEPLOYMENT_PATH }}
        
    - name: Copy Docker images to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.SERVER_HOST }}
        username: ${{ env.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        source: "*.tar.gz"
        target: ${{ env.DEPLOYMENT_PATH }}
        
    - name: Load and Start Services
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ env.SERVER_HOST }}
        username: ${{ env.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          cd ${{ env.DEPLOYMENT_PATH }}
          
          # Load Docker image
          docker load < ollo-api.tar.gz
          
          # Set up environment
          chmod 600 .env
          
          # Start services (production mode - no override file)
          docker-compose -f docker-compose.yml up -d
          
          # Clean up
          rm -f ollo-api.tar.gz
          
          # Check service status
          docker-compose -f docker-compose.yml ps
          
          # Wait for services to be ready
          sleep 30
          
          # Health check - test if container is running
          docker-compose -f docker-compose.yml logs --tail 10 api
          
          # Simple container status check instead of HTTP health check
          if [ "$(docker inspect -f '{{.State.Running}}' ollo-api)" = "true" ]; then
            echo "API container is running successfully"
          else
            echo "API container failed to start"
            exit 1
          fi
          
          echo "API deployment completed successfully!"