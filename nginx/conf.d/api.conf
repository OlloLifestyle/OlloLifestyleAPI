# Internal API Server (HTTP only for Docker communication)
server {
    listen 80;
    server_name localhost;

    # Additional security headers for API
    add_header X-API-Version "1.0" always;
    add_header X-Request-ID $request_id always;

    # API-specific rate limiting
    location /api/auth {
        limit_req zone=auth burst=10 nodelay;
        proxy_pass http://olloapi:8080;
        include /etc/nginx/conf.d/proxy.conf;
    }

    location /api {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://olloapi:8080;
        include /etc/nginx/conf.d/proxy.conf;
    }

    # Health check endpoint (no rate limiting)
    location /health {
        proxy_pass http://olloapi:8080;
        include /etc/nginx/conf.d/proxy.conf;
        access_log off;
    }

    # Swagger UI (if needed for internal testing)
    location /swagger {
        limit_req zone=general burst=5 nodelay;
        proxy_pass http://olloapi:8080;
        include /etc/nginx/conf.d/proxy.conf;
    }

    # Default location
    location / {
        limit_req zone=general burst=10 nodelay;
        proxy_pass http://olloapi:8080;
        include /etc/nginx/conf.d/proxy.conf;
    }

    # Security: Block access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~* \.(env|git|svn)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}